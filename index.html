<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå≥ Podas Arica - JSON (Servidor Local)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 80px);
        }
        
        .map-section {
            width: 80%;
            height: 100%;
            position: sticky;
            top: 0;
        }
        
        #map { 
            height: 100%;
            width: 100%;
        }
        
        .panel-section {
            width: 20%;
            height: 100%;
            overflow-y: auto;
            background: #f9fafb;
        }
        
        .leaflet-popup-content { min-width: 250px; }
        .leaflet-container { font-family: inherit; }
        
        .search-results {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .search-result-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.2s;
        }
        
        .search-result-item:hover {
            background-color: #eff6ff;
        }
        
        .panel-section::-webkit-scrollbar {
            width: 8px;
        }
        
        .panel-section::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .panel-section::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .panel-section::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Animaci√≥n de pulso para marcadores urgentes */
        @keyframes pulse-urgent {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .marker-urgent {
            animation: pulse-urgent 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-50">
    <header class="bg-gradient-to-r from-green-900 to-green-700 text-white p-4 shadow-lg">
        <div class="container mx-auto">
            <h1 class="text-2xl font-bold flex items-center gap-2">
                <i class="fas fa-tree"></i> Sistema de Podas Arica
                <span class="text-sm bg-green-500 px-2 py-1 rounded-full font-normal">
                    <i class="fas fa-cloud"></i> Google Sheets
                </span>
            </h1>
            <p class="text-green-100 mt-1">Gesti√≥n de podas programadas y urgentes en tiempo real</p>
        </div>
    </header>

    <div class="main-container">
        <!-- MAPA 80% -->
        <div class="map-section">
            <div class="relative h-full">
                <!-- Buscador de calles -->
                <div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-[1000] w-[500px] max-w-[90%]">
                    <div class="bg-white bg-opacity-95 backdrop-blur-sm rounded-lg shadow-xl border border-gray-200">
                        <div class="flex items-center p-3 gap-2">
                            <i class="fas fa-search text-green-600 text-lg"></i>
                            <input 
                                type="text" 
                                id="streetSearch" 
                                class="flex-1 outline-none text-gray-800 bg-transparent placeholder-gray-500 font-medium" 
                                placeholder="Buscar calle en Arica..."
                            >
                            <button id="clearSearch" class="text-gray-400 hover:text-gray-700 hidden transition">
                                <i class="fas fa-times-circle text-lg"></i>
                            </button>
                        </div>
                        <div id="searchResults" class="search-results hidden"></div>
                    </div>
                </div>
                
                <div id="map"></div>
                
                <!-- Controles de mapa -->
                <div class="absolute top-4 right-4 z-[1000]">
                    <div class="bg-white bg-opacity-95 backdrop-blur-sm rounded-lg shadow-xl border border-gray-200">
                        <div class="flex flex-col gap-2 p-2">
                            <div class="relative">
                                <button id="mapMenuBtn" class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white px-4 py-2.5 rounded-lg hover:from-green-700 hover:to-green-800 transition flex items-center justify-between gap-2 shadow-md">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-layer-group"></i>
                                        <span class="font-medium">Mapa</span>
                                    </div>
                                    <i class="fas fa-chevron-down text-sm"></i>
                                </button>
                                
                                <div id="mapLayersMenu" class="hidden absolute top-full right-0 mt-2 w-56 bg-white rounded-lg shadow-2xl border border-gray-200 overflow-hidden">
                                    <div class="p-2 space-y-1">
                                        <button class="map-layer-btn w-full text-left px-3 py-2.5 rounded hover:bg-blue-50 transition flex items-center gap-3" data-layer="streets">
                                            <i class="fas fa-road text-blue-600 w-5"></i>
                                            <span class="font-medium text-gray-700">Calles (Normal)</span>
                                        </button>
                                        <button class="map-layer-btn w-full text-left px-3 py-2.5 rounded hover:bg-gray-700 hover:text-white transition flex items-center gap-3" data-layer="dark">
                                            <i class="fas fa-moon text-gray-700 w-5"></i>
                                            <span class="font-medium text-gray-700">Oscuro</span>
                                        </button>
                                        <button class="map-layer-btn w-full text-left px-3 py-2.5 rounded hover:bg-green-50 transition flex items-center gap-3 bg-green-50" data-layer="satellite">
                                            <i class="fas fa-satellite text-green-600 w-5"></i>
                                            <span class="font-medium text-gray-700">Satelital ‚úì</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <button id="myLocationBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2.5 rounded-lg transition flex items-center justify-center gap-2 shadow-md">
                                <i class="fas fa-location-arrow"></i>
                                <span class="font-medium">Mi Ubicaci√≥n</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PANEL LATERAL 20% -->
        <div class="panel-section">
            <div class="p-4 space-y-4">
                <!-- Estad√≠sticas -->
                <div class="bg-white rounded-lg shadow p-4">
                    <h3 class="font-bold text-lg mb-3 text-gray-800 flex items-center gap-2">
                        <i class="fas fa-chart-bar text-green-600"></i> Estad√≠sticas
                    </h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <span class="text-gray-600">Total:</span>
                            <span id="totalCount" class="font-bold text-gray-800">0</span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-red-50 rounded">
                            <span class="text-red-700">üî¥ Urgentes:</span>
                            <span id="urgentCount" class="font-bold text-red-700">0</span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-blue-50 rounded">
                            <span class="text-blue-700">üìÖ Programadas:</span>
                            <span id="scheduledCount" class="font-bold text-blue-700">0</span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-green-50 rounded">
                            <span class="text-green-700">‚úÖ Realizadas:</span>
                            <span id="completedCount" class="font-bold text-green-700">0</span>
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n agregar poda -->
                <button id="addPruningBtn" class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white p-4 rounded-lg transition shadow-lg flex items-center justify-center gap-2">
                    <i class="fas fa-plus-circle text-xl"></i>
                    <span class="font-bold">Agregar Poda</span>
                </button>

                <!-- Bot√≥n probar conexi√≥n -->
                <button id="testConnectionBtn" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white p-3 rounded-lg transition shadow-lg flex items-center justify-center gap-2">
                    <i class="fas fa-plug text-lg"></i>
                    <span class="font-medium">Probar Conexi√≥n</span>
                </button>

                <!-- Filtros -->
                <div class="bg-white rounded-lg shadow p-4">
                    <h3 class="font-bold text-lg mb-3 text-gray-800 flex items-center gap-2">
                        <i class="fas fa-filter text-green-600"></i> Filtros
                    </h3>
                    <div class="space-y-2">
                        <button class="filter-btn w-full text-left px-3 py-2 rounded bg-gray-100 hover:bg-green-50 transition" data-filter="all">
                            <i class="fas fa-circle text-gray-400 mr-2"></i> Todas (<span class="filter-count">0</span>)
                        </button>
                        <button class="filter-btn w-full text-left px-3 py-2 rounded hover:bg-red-50 transition" data-filter="urgent">
                            <i class="fas fa-circle text-red-600 mr-2"></i> Urgentes (<span class="filter-count">0</span>)
                        </button>
                        <button class="filter-btn w-full text-left px-3 py-2 rounded hover:bg-blue-50 transition" data-filter="scheduled">
                            <i class="fas fa-circle text-blue-600 mr-2"></i> Programadas (<span class="filter-count">0</span>)
                        </button>
                        <button class="filter-btn w-full text-left px-3 py-2 rounded hover:bg-green-50 transition" data-filter="completed">
                            <i class="fas fa-circle text-green-600 mr-2"></i> Realizadas (<span class="filter-count">0</span>)
                        </button>
                    </div>
                </div>

                <!-- Lista de podas -->
                <div class="bg-white rounded-lg shadow p-4">
                    <h3 class="font-bold text-lg mb-3 text-gray-800 flex items-center gap-2">
                        <i class="fas fa-list text-green-600"></i> Podas Registradas
                    </h3>
                    <div id="pruningList" class="space-y-2 max-h-96 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Agregar Poda -->
    <div id="addModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[2000] items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-gradient-to-r from-green-600 to-green-700 text-white p-6 rounded-t-xl">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <i class="fas fa-tree"></i> Nueva Poda
                </h2>
                <button id="closeAddModal" class="absolute top-4 right-4 text-white hover:bg-white hover:bg-opacity-20 rounded-full w-8 h-8 flex items-center justify-center transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-4">
                <div>
                    <label class="block font-medium text-gray-700 mb-2">Tipo de Poda:</label>
                    <select id="pruningType" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="scheduled">üìÖ Programada</option>
                        <option value="urgent">üî¥ Urgente</option>
                    </select>
                </div>

                <div id="scheduledDateContainer">
                    <label class="block font-medium text-gray-700 mb-2">Fecha Programada:</label>
                    <input type="date" id="scheduledDate" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block font-medium text-gray-700 mb-2">Descripci√≥n:</label>
                    <textarea id="pruningDescription" rows="3" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Ej: Poda de √°rboles en calle principal..."></textarea>
                </div>
                
                <div>
                    <label class="block font-medium text-gray-700 mb-2">Ubicaci√≥n:</label>
                    <button id="selectLocationBtn" class="w-full bg-green-100 hover:bg-green-200 text-green-700 p-3 rounded-lg transition flex items-center justify-center gap-2">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Seleccionar en el Mapa</span>
                    </button>
                    <div id="selectedLocation" class="mt-2 p-3 bg-gray-50 rounded text-sm text-gray-600 hidden">
                        <i class="fas fa-check-circle text-green-600 mr-1"></i>
                        <span id="selectedLocationText">Ubicaci√≥n seleccionada</span>
                    </div>
                </div>
                
                <button id="savePruning" class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white p-4 rounded-lg transition font-bold">
                    <i class="fas fa-save mr-2"></i> Guardar Poda
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Detalle -->
    <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[2000] items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
            <div class="sticky top-0 bg-gradient-to-r from-green-600 to-green-700 text-white p-6 rounded-t-xl">
                <h2 class="text-2xl font-bold">Detalle de Poda</h2>
                <button id="closeModal" class="absolute top-4 right-4 text-white hover:bg-white hover:bg-opacity-20 rounded-full w-8 h-8 flex items-center justify-center transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="modalContent" class="p-6"></div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURACI√ìN
        // ============================================
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxHzPXpcT0FtgKU6ITeasgTrERgbOn0aGOCwgjql2EQM5fSugNWaONjcutRF-qaQG2q/exec';
        
        const typeColors = {
            urgent: '#ef4444',      // Rojo
            scheduled: '#3b82f6',   // Azul
            completed: '#10b981'    // Verde
        };

        let map;
        let prunings = [];
        let pruningMarkers = [];
        let currentFilter = 'all';
        let tempMarker = null;
        let selectedLat = null;
        let selectedLng = null;
        let currentLayer = 'satellite';
        let mapLayers = {};

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        $(document).ready(function() {
            // Inicializar mapa con vista satelital
            map = L.map('map', {
                zoomControl: false
            }).setView([-18.4746, -70.2979], 13);

            // Definir capas
            mapLayers = {
                streets: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 20,
                    attribution: '¬© OpenStreetMap'
                }),
                dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    maxZoom: 20,
                    attribution: '¬© CartoDB'
                }),
                satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    maxZoom: 20,
                    attribution: '¬© Esri'
                })
            };

            // Agregar capa satelital por defecto
            mapLayers.satellite.addTo(map);

            L.control.zoom({ position: 'bottomright' }).addTo(map);

            // ============================================
            // FUNCIONES DE GOOGLE SHEETS
            // ============================================
            function loadData() {
                console.log('üì• Cargando podas desde Google Sheets...');
                
                $.get(GOOGLE_SCRIPT_URL + '?action=getAll')
                    .done(function(response) {
                        console.log('‚úÖ Respuesta recibida:', response);
                        
                        if (typeof response === 'string') {
                            try { response = JSON.parse(response); } catch(e) {
                                console.error('‚ùå Error al parsear JSON:', e);
                                return;
                            }
                        }
                        
                        if (response && response.success) {
                            prunings = response.data || [];
                            console.log('üìä Podas cargadas:', prunings.length);
                            updateMap();
                            updateStats();
                            updateList();
                        } else {
                            console.error('‚ùå Error en respuesta:', response);
                        }
                    })
                    .fail(function(xhr, status, error) {
                        console.error('‚ùå Error de conexi√≥n:', error);
                        alert('Error al conectar con Google Sheets. Verifica la URL del script.');
                    });
            }

            function savePruning(data) {
                return $.ajax({
                    url: GOOGLE_SCRIPT_URL,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        action: 'add',
                        ...data
                    })
                });
            }

            function updatePruningStatus(id, status) {
                return $.ajax({
                    url: GOOGLE_SCRIPT_URL,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        action: 'updateStatus',
                        id: id,
                        status: status
                    })
                });
            }

            function deletePruningFromSheet(id) {
                return $.ajax({
                    url: GOOGLE_SCRIPT_URL,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        action: 'delete',
                        id: id
                    })
                });
            }

            // ============================================
            // ACTUALIZAR MAPA
            // ============================================
            function updateMap() {
                pruningMarkers.forEach(m => map.removeLayer(m));
                pruningMarkers = [];

                const filtered = currentFilter === 'all' ? prunings : prunings.filter(p => p.type === currentFilter);

                filtered.forEach(p => {
                    const iconHtml = p.status === 'Realizada' 
                        ? '<i class="fas fa-check-circle" style="color:#10b981; font-size:24px;"></i>'
                        : p.type === 'urgent'
                        ? '<i class="fas fa-exclamation-triangle marker-urgent" style="color:#ef4444; font-size:24px;"></i>'
                        : '<i class="fas fa-calendar-alt" style="color:#3b82f6; font-size:24px;"></i>';

                    const icon = L.divIcon({
                        html: iconHtml,
                        className: 'custom-marker',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    });

                    const marker = L.marker([p.lat, p.lng], { icon: icon })
                        .bindPopup(`
                            <div class="p-2">
                                <div class="font-bold text-lg mb-2 flex items-center gap-2">
                                    ${p.type === 'urgent' ? 'üî¥ Urgente' : 'üìÖ Programada'}
                                    ${p.status === 'Realizada' ? '<span class="text-green-600">‚úì</span>' : ''}
                                </div>
                                <p class="text-sm mb-2">${p.description}</p>
                                ${p.scheduledDate ? `<p class="text-xs text-gray-600">üìÖ ${new Date(p.scheduledDate).toLocaleDateString()}</p>` : ''}
                                <button onclick="viewDetail('${p.id}')" class="mt-2 bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm w-full">
                                    Ver Detalles
                                </button>
                            </div>
                        `)
                        .addTo(map);

                    pruningMarkers.push(marker);
                });
            }

            // ============================================
            // ACTUALIZAR ESTAD√çSTICAS
            // ============================================
            function updateStats() {
                const urgent = prunings.filter(p => p.type === 'urgent' && p.status !== 'Realizada').length;
                const scheduled = prunings.filter(p => p.type === 'scheduled' && p.status !== 'Realizada').length;
                const completed = prunings.filter(p => p.status === 'Realizada').length;

                $('#totalCount').text(prunings.length);
                $('#urgentCount').text(urgent);
                $('#scheduledCount').text(scheduled);
                $('#completedCount').text(completed);

                // Actualizar contadores de filtros
                $('.filter-btn[data-filter="all"] .filter-count').text(prunings.length);
                $('.filter-btn[data-filter="urgent"] .filter-count').text(urgent);
                $('.filter-btn[data-filter="scheduled"] .filter-count').text(scheduled);
                $('.filter-btn[data-filter="completed"] .filter-count').text(completed);
            }

            // ============================================
            // ACTUALIZAR LISTA
            // ============================================
            function updateList() {
                const filtered = currentFilter === 'all' ? prunings : prunings.filter(p => {
                    if (currentFilter === 'completed') return p.status === 'Realizada';
                    return p.type === currentFilter && p.status !== 'Realizada';
                });

                const sortedPrunings = filtered.sort((a, b) => {
                    if (a.type === 'urgent' && b.type !== 'urgent') return -1;
                    if (a.type !== 'urgent' && b.type === 'urgent') return 1;
                    return new Date(b.date) - new Date(a.date);
                });

                const html = sortedPrunings.map(p => `
                    <div class="p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition" onclick="viewDetail('${p.id}')">
                        <div class="flex items-start gap-2">
                            <div class="w-3 h-3 rounded-full mt-1 flex-shrink-0" style="background:${p.status === 'Realizada' ? typeColors.completed : typeColors[p.type]}"></div>
                            <div class="flex-1 min-w-0">
                                <div class="font-medium text-sm text-gray-800 truncate">
                                    ${p.type === 'urgent' ? 'üî¥' : 'üìÖ'} ${p.description}
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    ${new Date(p.date).toLocaleDateString()}
                                    ${p.status === 'Realizada' ? ' ‚Ä¢ <span class="text-green-600">‚úì Realizada</span>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                $('#pruningList').html(html || '<p class="text-gray-500 text-sm text-center py-4">No hay podas registradas</p>');
            }

            // ============================================
            // CAMBIO DE CAPAS
            // ============================================
            $('#mapMenuBtn').click(function(e) {
                e.stopPropagation();
                $('#mapLayersMenu').toggleClass('hidden');
            });

            $(document).click(function() {
                $('#mapLayersMenu').addClass('hidden');
            });

            $('.map-layer-btn').click(function(e) {
                e.stopPropagation();
                const layer = $(this).data('layer');
                
                map.eachLayer(l => {
                    if (l !== map && Object.values(mapLayers).includes(l)) {
                        map.removeLayer(l);
                    }
                });
                
                mapLayers[layer].addTo(map);
                currentLayer = layer;
                
                $('.map-layer-btn').removeClass('bg-green-50').find('span').html(function() {
                    return $(this).text().replace(' ‚úì', '');
                });
                
                $(this).addClass('bg-green-50').find('span').append(' ‚úì');
                $('#mapLayersMenu').addClass('hidden');
            });

            // ============================================
            // MI UBICACI√ìN
            // ============================================
            $('#myLocationBtn').click(function() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            map.setView([position.coords.latitude, position.coords.longitude], 16);
                            L.marker([position.coords.latitude, position.coords.longitude])
                                .addTo(map)
                                .bindPopup('üìç Tu ubicaci√≥n')
                                .openPopup();
                        },
                        function() {
                            alert('No se pudo obtener tu ubicaci√≥n');
                        }
                    );
                } else {
                    alert('Tu navegador no soporta geolocalizaci√≥n');
                }
            });

            // ============================================
            // B√öSQUEDA DE CALLES
            // ============================================
            let searchTimeout;
            $('#streetSearch').on('input', function() {
                const query = $(this).val().trim();
                
                if (query.length < 3) {
                    $('#searchResults').addClass('hidden');
                    $('#clearSearch').addClass('hidden');
                    return;
                }
                
                $('#clearSearch').removeClass('hidden');
                clearTimeout(searchTimeout);
                
                searchTimeout = setTimeout(function() {
                    $('#searchResults').html('<div class="search-loading"><i class="fas fa-spinner fa-spin mr-2"></i>Buscando...</div>').removeClass('hidden');
                    
                    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ', Arica, Chile')}&limit=5`;
                    
                    $.getJSON(url)
                        .done(function(data) {
                            if (data.length === 0) {
                                $('#searchResults').html('<div class="search-loading text-gray-500">No se encontraron resultados</div>');
                                return;
                            }
                            
                            const html = data.map(item => `
                                <div class="search-result-item" data-lat="${item.lat}" data-lng="${item.lon}">
                                    <div class="font-medium text-gray-800">${item.display_name.split(',')[0]}</div>
                                    <div class="text-xs text-gray-500 mt-1">${item.display_name}</div>
                                </div>
                            `).join('');
                            
                            $('#searchResults').html(html);
                        })
                        .fail(function() {
                            $('#searchResults').html('<div class="search-loading text-red-500">Error en la b√∫squeda</div>');
                        });
                }, 500);
            });

            $(document).on('click', '.search-result-item', function() {
                const lat = parseFloat($(this).data('lat'));
                const lng = parseFloat($(this).data('lng'));
                map.setView([lat, lng], 17);
                $('#searchResults').addClass('hidden');
                $('#streetSearch').val('');
                $('#clearSearch').addClass('hidden');
            });

            $('#clearSearch').click(function() {
                $('#streetSearch').val('');
                $('#searchResults').addClass('hidden');
                $(this).addClass('hidden');
            });

            // ============================================
            // FILTROS
            // ============================================
            $('.filter-btn').click(function() {
                currentFilter = $(this).data('filter');
                
                $('.filter-btn').removeClass('bg-gray-100 bg-red-50 bg-blue-50 bg-green-50');
                $(this).addClass(
                    currentFilter === 'all' ? 'bg-gray-100' :
                    currentFilter === 'urgent' ? 'bg-red-50' :
                    currentFilter === 'scheduled' ? 'bg-blue-50' : 'bg-green-50'
                );
                
                updateMap();
                updateList();
            });

            // ============================================
            // AGREGAR PODA
            // ============================================
            $('#addPruningBtn').click(function() {
                $('#addModal').removeClass('hidden').addClass('flex');
            });

            // ============================================
            // PROBAR CONEXI√ìN
            // ============================================
            $('#testConnectionBtn').click(function() {
                const btn = $(this);
                const originalHtml = btn.html();
                
                btn.html('<i class="fas fa-spinner fa-spin mr-2"></i>Probando...').prop('disabled', true);
                
                console.log('üß™ Probando conexi√≥n con:', GOOGLE_SCRIPT_URL);
                
                $.get(GOOGLE_SCRIPT_URL + '?action=test')
                    .done(function(response) {
                        console.log('‚úÖ Respuesta de prueba:', response);
                        
                        if (typeof response === 'string') {
                            try { response = JSON.parse(response); } catch(e) {}
                        }
                        
                        if (response && response.success) {
                            alert('‚úÖ CONEXI√ìN EXITOSA!\n\n' + 
                                  'El script est√° funcionando correctamente.\n' + 
                                  'Timestamp: ' + response.timestamp + '\n\n' +
                                  'Ahora puedes agregar podas sin problemas.');
                        } else {
                            alert('‚ö†Ô∏è Respuesta recibida pero con errores:\n\n' + 
                                  JSON.stringify(response, null, 2));
                        }
                    })
                    .fail(function(xhr, status, error) {
                        console.error('‚ùå Error en prueba de conexi√≥n:', {xhr, status, error});
                        
                        let errorMsg = '‚ùå ERROR DE CONEXI√ìN\n\n';
                        errorMsg += 'No se pudo conectar con Google Sheets.\n\n';
                        errorMsg += 'Detalles t√©cnicos:\n';
                        errorMsg += '‚Ä¢ Status HTTP: ' + xhr.status + '\n';
                        errorMsg += '‚Ä¢ Error: ' + error + '\n\n';
                        
                        if (xhr.status === 0) {
                            errorMsg += '‚ö†Ô∏è POSIBLES CAUSAS:\n';
                            errorMsg += '1. La URL del script es incorrecta\n';
                            errorMsg += '2. El script no est√° publicado\n';
                            errorMsg += '3. Los permisos est√°n mal configurados\n';
                            errorMsg += '4. Problemas de CORS\n\n';
                            errorMsg += 'üìã SOLUCI√ìN:\n';
                            errorMsg += '‚Ä¢ Ve a Google Apps Script\n';
                            errorMsg += '‚Ä¢ Implementar ‚Üí Nueva implementaci√≥n\n';
                            errorMsg += '‚Ä¢ Tipo: Aplicaci√≥n web\n';
                            errorMsg += '‚Ä¢ Ejecutar como: YO\n';
                            errorMsg += '‚Ä¢ Acceso: CUALQUIER USUARIO\n';
                        } else if (xhr.status === 404) {
                            errorMsg += '‚ö†Ô∏è SCRIPT NO ENCONTRADO (404)\n';
                            errorMsg += 'La URL del script es incorrecta.\n';
                        } else if (xhr.status === 403) {
                            errorMsg += '‚ö†Ô∏è ACCESO DENEGADO (403)\n';
                            errorMsg += 'Revisa los permisos del script.\n';
                        }
                        
                        alert(errorMsg);
                    })
                    .always(function() {
                        btn.html(originalHtml).prop('disabled', false);
                    });
            });

            $('#closeAddModal').click(function() {
                $('#addModal').removeClass('flex').addClass('hidden');
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                    tempMarker = null;
                }
                selectedLat = null;
                selectedLng = null;
                $('#pruningDescription').val('');
                $('#scheduledDate').val('');
                $('#selectedLocation').addClass('hidden');
            });

            // Mostrar/ocultar campo de fecha seg√∫n tipo
            $('#pruningType').change(function() {
                if ($(this).val() === 'scheduled') {
                    $('#scheduledDateContainer').show();
                } else {
                    $('#scheduledDateContainer').hide();
                }
            });

            $('#selectLocationBtn').click(function() {
                alert('Haz clic en el mapa para seleccionar la ubicaci√≥n de la poda');
                $('#addModal').removeClass('flex').addClass('hidden');
                
                map.once('click', function(e) {
                    selectedLat = e.latlng.lat;
                    selectedLng = e.latlng.lng;
                    
                    if (tempMarker) map.removeLayer(tempMarker);
                    
                    tempMarker = L.marker([selectedLat, selectedLng], {
                        icon: L.divIcon({
                            html: '<i class="fas fa-map-pin" style="color:#ef4444; font-size:32px;"></i>',
                            className: 'temp-marker',
                            iconSize: [32, 32],
                            iconAnchor: [16, 32]
                        })
                    }).addTo(map);
                    
                    $('#selectedLocation').removeClass('hidden');
                    $('#selectedLocationText').text(`Lat: ${selectedLat.toFixed(6)}, Lng: ${selectedLng.toFixed(6)}`);
                    $('#addModal').removeClass('hidden').addClass('flex');
                });
            });

            $('#savePruning').click(function() {
                const type = $('#pruningType').val();
                const description = $('#pruningDescription').val().trim();
                const scheduledDate = $('#scheduledDate').val();

                if (!description) {
                    alert('Por favor ingresa una descripci√≥n');
                    return;
                }

                if (!selectedLat || !selectedLng) {
                    alert('Por favor selecciona una ubicaci√≥n en el mapa');
                    return;
                }

                if (type === 'scheduled' && !scheduledDate) {
                    alert('Por favor selecciona una fecha para la poda programada');
                    return;
                }

                $(this).html('<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...').prop('disabled', true);

                const pruningData = {
                    lat: selectedLat,
                    lng: selectedLng,
                    type: type,
                    description: description,
                    scheduledDate: type === 'scheduled' ? scheduledDate : null
                };

                savePruning(pruningData)
                    .done(function(response) {
                        console.log('üì• Respuesta completa:', response);
                        console.log('üì• Tipo de respuesta:', typeof response);
                        
                        if (typeof response === 'string') {
                            try { 
                                response = JSON.parse(response); 
                                console.log('‚úÖ JSON parseado:', response);
                            } catch(e) {
                                console.error('‚ùå Error al parsear JSON:', e);
                                console.error('‚ùå Respuesta raw:', response);
                            }
                        }

                        if (response && response.success) {
                            alert('‚úÖ Poda registrada exitosamente con ID: ' + response.id);
                            $('#addModal').removeClass('flex').addClass('hidden');
                            if (tempMarker) map.removeLayer(tempMarker);
                            tempMarker = null;
                            selectedLat = null;
                            selectedLng = null;
                            $('#pruningDescription').val('');
                            $('#scheduledDate').val('');
                            $('#selectedLocation').addClass('hidden');
                            loadData();
                        } else {
                            console.error('‚ùå Respuesta de error:', response);
                            alert('‚ùå Error al guardar: ' + (response.message || 'Respuesta inv√°lida del servidor'));
                        }
                    })
                    .fail(function(xhr, status, error) {
                        console.error('‚ùå Error completo:', {xhr, status, error});
                        console.error('‚ùå Response Text:', xhr.responseText);
                        console.error('‚ùå Status:', xhr.status);
                        
                        let errorMsg = 'Error al guardar la poda.\n\n';
                        errorMsg += 'Detalles t√©cnicos:\n';
                        errorMsg += '‚Ä¢ Status: ' + xhr.status + '\n';
                        errorMsg += '‚Ä¢ Error: ' + error + '\n';
                        
                        if (xhr.status === 0) {
                            errorMsg += '\n‚ö†Ô∏è No se pudo conectar con Google Sheets.\n';
                            errorMsg += 'Verifica:\n';
                            errorMsg += '1. La URL del script es correcta\n';
                            errorMsg += '2. El script est√° publicado\n';
                            errorMsg += '3. Los permisos est√°n configurados\n';
                        } else if (xhr.status === 404) {
                            errorMsg += '\n‚ö†Ô∏è Script no encontrado (404)\n';
                            errorMsg += 'La URL del script podr√≠a estar incorrecta.\n';
                        } else if (xhr.status === 403) {
                            errorMsg += '\n‚ö†Ô∏è Acceso denegado (403)\n';
                            errorMsg += 'Revisa los permisos del script.\n';
                        }
                        
                        alert(errorMsg);
                    })
                    .always(function() {
                        $('#savePruning').html('<i class="fas fa-save mr-2"></i> Guardar Poda').prop('disabled', false);
                    });
            });

            // ============================================
            // VER DETALLE
            // ============================================
            window.viewDetail = function(id) {
                const p = prunings.find(p => p.id == id);
                if (!p) return;

                const isCompleted = p.status === 'Realizada';

                $('#modalContent').html(`
                    <div class="space-y-4">
                        <div class="flex items-center gap-3">
                            <div class="w-6 h-6 rounded-full" style="background:${isCompleted ? typeColors.completed : typeColors[p.type]}"></div>
                            <div>
                                <h4 class="font-bold text-lg">${p.type === 'urgent' ? 'üî¥ Urgente' : 'üìÖ Programada'}</h4>
                                <p class="text-sm text-gray-600">Registrado: ${new Date(p.date).toLocaleString()}</p>
                            </div>
                        </div>

                        <div>
                            <h5 class="font-medium text-gray-700 mb-1">Estado:</h5>
                            <span class="${isCompleted ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-700'} px-3 py-1 rounded-full text-sm font-medium">
                                ${isCompleted ? '‚úì Realizada' : '‚è± Pendiente'}
                            </span>
                        </div>

                        ${p.scheduledDate ? `
                        <div>
                            <h5 class="font-medium text-gray-700 mb-1">Fecha Programada:</h5>
                            <p class="text-gray-600 p-3 bg-blue-50 rounded">üìÖ ${new Date(p.scheduledDate).toLocaleDateString('es-CL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                        </div>
                        ` : ''}

                        <div>
                            <h5 class="font-medium text-gray-700 mb-1">Descripci√≥n:</h5>
                            <p class="text-gray-600 p-3 bg-gray-50 rounded">${p.description}</p>
                        </div>

                        <div>
                            <h5 class="font-medium text-gray-700 mb-1">Ubicaci√≥n:</h5>
                            <p class="text-gray-600">Lat: ${p.lat.toFixed(6)} | Lng: ${p.lng.toFixed(6)}</p>
                        </div>

                        <div class="grid grid-cols-2 gap-3 pt-4">
                            <button onclick="zoomToPruning('${p.id}', 18)" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded transition">
                                <i class="fas fa-search-plus mr-2"></i>Zoom 18x
                            </button>
                            <button onclick="zoomToPruning('${p.id}', 20)" class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded transition">
                                <i class="fas fa-search mr-2"></i>Zoom 20x
                            </button>
                            ${!isCompleted ? `
                            <button onclick="markAsCompleted('${p.id}')" class="col-span-2 bg-green-600 hover:bg-green-700 text-white p-3 rounded transition">
                                <i class="fas fa-check mr-2"></i>Marcar como Realizada
                            </button>
                            ` : ''}
                            <button onclick="deletePruning('${p.id}')" class="col-span-2 bg-red-600 hover:bg-red-700 text-white p-3 rounded transition">
                                <i class="fas fa-trash mr-2"></i>Eliminar
                            </button>
                        </div>
                    </div>
                `);

                $('#detailModal').removeClass('hidden').addClass('flex');
            };

            window.markAsCompleted = function(id) {
                if (confirm('¬øMarcar esta poda como realizada?')) {
                    updatePruningStatus(id, 'Realizada')
                        .done(function(response) {
                            if (typeof response === 'string') {
                                try { response = JSON.parse(response); } catch(e) {}
                            }

                            if (response && response.success) {
                                alert('‚úÖ Poda marcada como realizada');
                                $('#detailModal').removeClass('flex').addClass('hidden');
                                loadData();
                            } else {
                                alert('Error: ' + (response.message || 'Desconocido'));
                            }
                        })
                        .fail(function(xhr, status, error) {
                            console.error('‚ùå Error:', error);
                            alert('Error al actualizar estado');
                        });
                }
            };

            window.zoomToPruning = function(id, zoomLevel = 18) {
                const p = prunings.find(p => p.id == id);
                if (p) {
                    map.setView([p.lat, p.lng], Math.min(zoomLevel, 20));
                    $('#detailModal').removeClass('flex').addClass('hidden');

                    const markerIndex = prunings.findIndex(pf => pf.id == id);
                    if (pruningMarkers[markerIndex]) {
                        pruningMarkers[markerIndex].openPopup();
                    }
                }
            };

            window.deletePruning = function(id) {
                if (confirm('¬øEliminar este registro de poda?')) {
                    deletePruningFromSheet(id)
                        .done(function(response) {
                            if (response.success) {
                                alert('‚úÖ Poda eliminada exitosamente');
                                $('#detailModal').removeClass('flex').addClass('hidden');
                                loadData();
                            } else {
                                alert('Error: ' + response.message);
                            }
                        })
                        .fail(function(xhr, status, error) {
                            console.error('‚ùå Error:', error);
                            alert('Error al eliminar');
                        });
                }
            };

            $('#closeModal').click(function() {
                $('#detailModal').removeClass('flex').addClass('hidden');
            });

            // ============================================
            // INICIAR
            // ============================================
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üå≥ SISTEMA DE PODAS ARICA - INICIADO');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('');
            console.log('üîó Google Sheets URL configurada:');
            console.log(GOOGLE_SCRIPT_URL);
            console.log('');
            console.log('üß™ Para probar la conexi√≥n, haz clic en el bot√≥n:');
            console.log('   "Probar Conexi√≥n" en el panel lateral');
            console.log('');
            console.log('üìã O prueba manualmente abriendo esta URL:');
            console.log(GOOGLE_SCRIPT_URL + '?action=test');
            console.log('');
            console.log('‚úÖ Si ves {"success":true,...}, la conexi√≥n funciona');
            console.log('‚ùå Si ves un error, revisa la configuraci√≥n del script');
            console.log('');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

            loadData();
        });
    </script>
</body>
</html>
